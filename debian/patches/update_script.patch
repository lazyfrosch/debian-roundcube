patch update scripts to work with debian package together

Index: roundcube/bin/update.sh
===================================================================
--- roundcube.orig/bin/update.sh	2015-03-21 23:32:40.223053966 +0100
+++ roundcube/bin/update.sh	2015-03-21 23:32:40.216387239 +0100
@@ -19,6 +19,14 @@
  +-----------------------------------------------------------------------+
 */
 
+if ($_SERVER['RCMAIL_CONFIG_DIR']) {
+  define('RCMAIL_CONFIG_DIR', $_SERVER['RCMAIL_CONFIG_DIR']);
+}
+
+if ($_SERVER['DEBIAN_PKG']) {
+  define('DEBIAN_PKG', TRUE);
+}
+
 define('INSTALL_PATH', realpath(dirname(__FILE__) . '/..') . '/' );
 
 require_once INSTALL_PATH . 'program/include/clisetup.php';
@@ -87,20 +95,26 @@
       if ($opts['accept'] || strtolower($input) == 'y') {
         $error = $written = false;
 
-        // backup current config
-        echo ". backing up the current config file(s)...\n";
-
-        foreach (array('config', 'main', 'db') as $file) {
-          if (file_exists(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php')) {
-            if (!copy(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php', RCMAIL_CONFIG_DIR . '/' . $file . '.old.php')) {
-              $error = true;
+        if (!DEBIAN_PKG) {
+          // backup current config
+          echo ". backing up the current config file(s)...\n";
+
+          foreach (array('config', 'main', 'db') as $file) {
+            if (file_exists(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php')) {
+              if (!copy(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php', RCMAIL_CONFIG_DIR . '/' . $file . '.old.php')) {
+                $error = true;
+              }
             }
           }
         }
 
         if (!$error) {
           $RCI->merge_config();
-          echo ". writing " . RCMAIL_CONFIG_DIR . "/config.inc.php...\n";
+          if (DEBIAN_PKG) {
+            echo ". writing " . RCMAIL_CONFIG_DIR . "/config.inc.php.dpkg-new...\n";
+          } else {
+            echo ". writing " . RCMAIL_CONFIG_DIR . "/config.inc.php...\n";
+          }
           $written = $RCI->save_configfile($RCI->create_config());
         }
 
@@ -115,9 +129,11 @@
               echo "- '" . $msg['prop'] . ($msg['name'] ? "': " . $msg['name'] : "'") . "\n";
           }
 
-          if ($RCI->legacy_config) {
-            foreach (array('main', 'db') as $file) {
-              @unlink(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php');
+          if (!DEBIAN_PKG) {
+            if ($RCI->legacy_config) {
+              foreach (array('main', 'db') as $file) {
+                @unlink(RCMAIL_CONFIG_DIR . '/' . $file . '.inc.php');
+              }
             }
           }
         }
@@ -154,13 +170,15 @@
     echo "Please check the 'mime_types' config option and run this script again.\n";
   }
 
-  // check database schema
-  if ($RCI->config['db_dsnw']) {
-    echo "Executing database schema update.\n";
-    system("php " . INSTALL_PATH . "bin/updatedb.sh --package=roundcube --version=" . $opts['version']
-      . " --dir=" . INSTALL_PATH . DIRECTORY_SEPARATOR . "SQL", $res);
+  if (!DEBIAN_PKG) {
+    // check database schema
+    if ($RCI->config['db_dsnw']) {
+      echo "Executing database schema update.\n";
+      system("php " . INSTALL_PATH . "bin/updatedb.sh --package=roundcube --version=" . $opts['version']
+        . " --dir=" . INSTALL_PATH . DIRECTORY_SEPARATOR . "SQL", $res);
 
-    $success = !$res;
+      $success = !$res;
+    }
   }
 
   // index contacts for fulltext searching
Index: roundcube/installer/rcube_install.php
===================================================================
--- roundcube.orig/installer/rcube_install.php	2015-03-21 23:32:40.223053966 +0100
+++ roundcube/installer/rcube_install.php	2015-03-22 01:01:46.949261844 +0100
@@ -103,10 +103,23 @@
         $this->config = array_merge($this->config, $config);
         $this->legacy_config = true;
       }
+
+      // Debian save its old config in dpkg-bak file
+      if (DEBIAN_PKG &&  $config = $this->load_config_file(RCUBE_CONFIG_DIR . 'main.inc.php.dpkg-bak')) {
+        $this->config = array_merge($this->config, $config);
+        $this->legacy_config = true;
+      }
+
       if ($config = $this->load_config_file(RCUBE_CONFIG_DIR . 'db.inc.php')) {
         $this->config = array_merge($this->config, $config);
         $this->legacy_config = true;
       }
+
+      // Debian save its old config in dpkg-bak file
+      if (DEBIAN_PKG &&  $config = $this->load_config_file(RCUBE_CONFIG_DIR . 'db.inc.php.dpkg-bak')) {
+        $this->config = array_merge($this->config, $config);
+        $this->legacy_config = true;
+      }
     }
 
     $this->configured = !empty($config);
@@ -255,9 +268,11 @@
         continue;
       }
 
+      if (!DEBIAN_PKG || $prop != 'db_dsnw') {
       // save change
       $this->config[$prop] = $value;
       $config[$prop] = $value;
+      }
     }
 
     $out = "<?php\n\n";
@@ -268,6 +283,10 @@
       $out .= "\$config['$prop'] = " . rcube_install::_dump_var($value, $prop) . ";\n\n";
     }
 
+    if (DEBIAN_PKG) {
+       $out .= "/* Do not set db_dsnw here, use dpkg-reconfigure roundcube-core to configure database ! */\n";
+       $out .= "include_once(\"/etc/roundcube/debian-db-roundcube.php\");\n";
+    }
     return $out;
   }
 
@@ -279,8 +298,13 @@
    */
   function save_configfile($config)
   {
+    $filename = "config.inc.php";
+
+    if (DEBIAN_PKG) {
+      $filename = "config.inc.php.dpkg-new";
+    }
     if (is_writable(RCUBE_CONFIG_DIR)) {
-      return file_put_contents(RCUBE_CONFIG_DIR . 'config.inc.php', $config);
+      return file_put_contents(RCUBE_CONFIG_DIR . $filename, $config);
     }
 
     return false;
Index: roundcube/program/include/iniset.php
===================================================================
--- roundcube.orig/program/include/iniset.php	2015-03-21 23:32:40.223053966 +0100
+++ roundcube/program/include/iniset.php	2015-03-21 23:32:40.216387239 +0100
@@ -36,6 +36,10 @@
     define('RCUBE_LOCALIZATION_DIR', INSTALL_PATH . 'program/localization/');
 }
 
+if (!defined('DEBIAN_PKG')) {
+    define('DEBIAN_PKG', FALSE);
+}
+
 define('RCUBE_INSTALL_PATH', INSTALL_PATH);
 define('RCUBE_CONFIG_DIR',  RCMAIL_CONFIG_DIR.'/');
 
